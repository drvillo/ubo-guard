// Prisma schema for Personal KYC Vault MVP
// Step 1: Owner vault + encryption + upload/list/replace/download
// Step 2: Team invites + delegate role + share requests
// Step 3: Owner approval + share links + vendor secret delivery

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// User profiles (app-specific fields, linked to Supabase Auth user id)
model UserProfile {
  id        String   @id @default(uuid())
  userId    String   @unique // Supabase Auth user id
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  vault            Vault?            @relation("VaultOwner")
  teamMemberships  TeamMembership[]
  createdInvites   TeamInvite[]      @relation("InviteCreator")
  acceptedInvites  TeamInvite[]      @relation("InviteAccepter")
  createdRequests  ShareRequest[]
  createdLinks     ShareLink[]
  approvedLinks    ShareLink[]       @relation("LinkApprover")
  auditEvents      AuditEvent[]

  @@map("user_profiles")
}

// Vaults (one per owner)
model Vault {
  id         String   @id @default(uuid())
  ownerId    String   @unique
  kdfSalt    String   // Base64-encoded random salt for Argon2id
  kdfParams  Json     // { memory, time, parallelism } for consistent derivation
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  owner           UserProfile      @relation("VaultOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  documents       Document[]
  teamMemberships TeamMembership[]
  teamInvites     TeamInvite[]
  shareRequests   ShareRequest[]
  shareLinks      ShareLink[]
  auditEvents     AuditEvent[]

  @@map("vaults")
}

// Document types enum (MVP: ID, ProofOfAddress, SourceOfWealth)
enum DocumentType {
  ID
  ProofOfAddress
  SourceOfWealth
}

// Documents (encrypted ciphertext stored in object storage)
model Document {
  id                    String       @id @default(uuid())
  vaultId               String
  docType               DocumentType
  storagePath           String       // Path in object storage (e.g., vaults/{vaultId}/{docType}/{id}.bin)
  ciphertextChecksum    String       // SHA-256 hash of ciphertext blob
  size                  Int          // Size in bytes
  filename              String       // Original filename
  uploadedAt            DateTime     @default(now())
  lastUpdatedBy         String       // User id
  encryptedDekForOwner  String       // Base64-encoded: DEK encrypted with KEK (AES-GCM)
  dekNonce              String       // Base64-encoded: nonce/IV for DEK wrapping

  vault                 Vault        @relation(fields: [vaultId], references: [id], onDelete: Cascade)
  shareLinkDocuments    ShareLinkDocument[]

  @@unique([vaultId, docType]) // Only one document per type per vault
  @@map("documents")
}

// Team membership roles
enum TeamRole {
  owner
  delegate
}

// Team memberships (many-to-many: users can be members of multiple vaults)
model TeamMembership {
  id            String   @id @default(uuid())
  vaultId       String
  userId        String   // UserProfile.id
  role          TeamRole
  permissionsJson Json   // { allowedDocTypes: DocumentType[] }
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  vault         Vault        @relation(fields: [vaultId], references: [id], onDelete: Cascade)
  user          UserProfile   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([vaultId, userId])
  @@map("team_memberships")
}

// Team invites (pending invitations)
model TeamInvite {
  id            String    @id @default(uuid())
  vaultId       String
  invitedEmail  String
  role          TeamRole
  permissionsJson Json     // { allowedDocTypes: DocumentType[] }
  tokenHash     String    // SHA-256 hash of invite token (with pepper)
  expiresAt     DateTime
  acceptedAt    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdById   String    // UserProfile.id of inviter
  acceptedById  String?   // UserProfile.id of accepter

  vault         Vault        @relation(fields: [vaultId], references: [id], onDelete: Cascade)
  creator       UserProfile  @relation("InviteCreator", fields: [createdById], references: [id])
  accepter      UserProfile? @relation("InviteAccepter", fields: [acceptedById], references: [id])

  @@map("team_invites")
}

// Share request status
enum ShareRequestStatus {
  pending
  approved
  rejected
  cancelled
}

// Share requests (created by delegates, approved by owners)
model ShareRequest {
  id                String              @id @default(uuid())
  vaultId           String
  createdById       String              // UserProfile.id
  vendorLabel       String              // Human-readable vendor identifier
  vendorEmail       String?             // Vendor email address (for sending VS)
  purposeNotes      String?             // Optional notes about purpose
  requestedDocTypes DocumentType[]     // Array of document types requested
  expiresAt         DateTime            // When the share should expire
  status            ShareRequestStatus  @default(pending)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  vault             Vault        @relation(fields: [vaultId], references: [id], onDelete: Cascade)
  creator           UserProfile  @relation(fields: [createdById], references: [id])
  shareLink         ShareLink?

  @@map("share_requests")
}

// Share link status
enum ShareLinkStatus {
  pending
  approved
  revoked
}

// Share links (created from approved share requests)
model ShareLink {
  id                    String          @id @default(uuid())
  vaultId               String
  createdById           String          // UserProfile.id
  shareRequestId        String?         @unique // Optional link to originating request
  status                ShareLinkStatus @default(pending)
  approvedById          String?         // UserProfile.id of approver
  approvedAt            DateTime?
  vendorLabel           String
  vendorEmail           String          // Email to send VS to
  purposeNotes          String?
  expiresAt             DateTime
  revokedAt             DateTime?
  tokenHash             String          // SHA-256 hash of link token (with pepper)
  encryptedLskForVendor String?         // Base64-encoded: LSK encrypted with VS-derived key (nullable until approved)
  lskSalt               String?         // Base64-encoded: salt for HKDF derivation (nullable until approved)
  lskNonce              String?         // Base64-encoded: nonce/IV for LSK wrapping (nullable until approved)
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  vault                 Vault              @relation(fields: [vaultId], references: [id], onDelete: Cascade)
  creator               UserProfile        @relation(fields: [createdById], references: [id])
  approver              UserProfile?       @relation("LinkApprover", fields: [approvedById], references: [id])
  shareRequest          ShareRequest?      @relation(fields: [shareRequestId], references: [id])
  documents             ShareLinkDocument[]
  auditEvents           AuditEvent[]

  @@map("share_links")
}

// Share link documents (which documents are included in a link)
model ShareLinkDocument {
  id                    String       @id @default(uuid())
  shareLinkId           String
  documentId            String
  docType               DocumentType
  encryptedDekForLink   String       // Base64-encoded: DEK encrypted with LSK (AES-GCM)
  dekForLinkNonce       String       // Base64-encoded: nonce/IV for DEK wrapping
  createdAt             DateTime      @default(now())

  shareLink             ShareLink    @relation(fields: [shareLinkId], references: [id], onDelete: Cascade)
  document              Document     @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([shareLinkId, documentId])
  @@map("share_link_documents")
}

// Audit event types
enum AuditEventType {
  invite_created
  invite_accepted
  member_removed
  share_request_created
  share_request_approved
  share_request_rejected
  share_request_cancelled
  link_created
  link_revoked
}

// Audit actor types
enum AuditActorType {
  owner
  delegate
  system
}

// Audit events (append-only log)
model AuditEvent {
  id                  String          @id @default(uuid())
  vaultId             String
  actorType           AuditActorType
  actorId             String          // UserProfile.id (or 'system' for system events)
  eventType           AuditEventType
  linkId              String?         // Share link ID (nullable, for future use)
  docType             DocumentType?   // Document type involved (nullable)
  watermarkReferenceId String?       // Watermark reference (nullable, for future use)
  userAgent           String?
  ip                  String?
  createdAt           DateTime        @default(now())

  vault               Vault        @relation(fields: [vaultId], references: [id], onDelete: Cascade)
  actor               UserProfile? @relation(fields: [actorId], references: [id])
  shareLink           ShareLink?   @relation(fields: [linkId], references: [id])

  @@map("audit_events")
}

